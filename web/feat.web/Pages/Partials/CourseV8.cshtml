@using System.Globalization
@using System.Text.Json
@using System.Text.Json.Serialization
@using feat.common.Models.Enums
@model feat.web.Models.Course

@{
  
  string TruncateString(ReadOnlySpan<char> fullString, out string remainder, int cutoff = 300)
  {
    remainder = string.Empty;
    if (fullString.IsEmpty || fullString.Length <= cutoff)
      return fullString.ToString();
    
    int cutPosition = fullString[cutoff..].IndexOf('.');

    if (cutPosition == -1)
      return fullString.ToString();
    
    cutPosition += cutoff;
    remainder = fullString[(cutPosition + 1)..].ToString();
    return fullString[..cutPosition].ToString();
  }
  
}

<!-- Course Card -->
<div class="govuk-summary-card">
  <div class="govuk-summary-card__title-wrapper">
    <h2 class="govuk-summary-card__title">@Model.CourseTitle</h2>
    <ul class="govuk-summary-card__actions">
      <li class="govuk-summary-card__action">
        @{
          string courseDetails = "DetailsCourse";
          
          if (Model.CourseType == CourseType.Degree)
          {
            courseDetails = "DetailsUniversityDegree";
          }
          else if (Model.CourseType == CourseType.Apprenticeship)
          {
            courseDetails = "DetailsApprenticeship";
          }
          
          <a class="govuk-link" asp-page="./CourseDetails/@courseDetails" asp-route-id="@(Model.CourseId)">
            View more details<span class="govuk-visually-hidden">about @(Model.CourseTypeDisplay)</span>
          </a>
        }
      </li>
    </ul>
  </div>

  <div class="govuk-summary-card__content">
    <dl class="govuk-summary-list">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Provider</dt>
        <dd class="govuk-summary-list__value">@Model.ProviderName</dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Location</dt>
        <dd class="govuk-summary-list__value">
          @{
            bool hasTown = !string.IsNullOrEmpty(Model.Location);
            bool hasDistance = !string.IsNullOrEmpty(Model.Distance);

            @if (hasTown && hasDistance)
            {
              <p>@($"{Model.Location}, {Model.Distance}")</p>
            }
            else
            {
              if (!hasTown && hasDistance)
              {
                <p>@Model.Distance</p>
              }
              else
              {
                if (hasTown && !hasDistance)
                {
                  <p>@(Model.Location)</p>
                }
                else
                {
                  <p>Unavailable</p>
                }
              }
            }
          }
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Course type</dt>
        <dd class="govuk-summary-list__value">
          @{
            if (string.IsNullOrEmpty(Model.CourseTypeDisplay))
            {
              <p>Course type not provided</p>
            }
            else
            {
              <p>@Model.CourseTypeDisplay</p>
            }
          }
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Requirements</dt>
        <dd class="govuk-summary-list__value">
          @{
            if (string.IsNullOrEmpty(Model.Requirements))
            {
              <text>Unknown</text>
            }
            else
            {
              <p>@Model.Requirements</p>
            }
          }
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Overview</dt>
        <dd class="govuk-summary-list__value">
          @if (string.IsNullOrEmpty(Model.Overview))
          {
            <p>Course overview not found</p>
          }
          else
          {
            var shortendText = TruncateString(Model.Overview, out string tailEndText);
            if (string.IsNullOrEmpty(tailEndText))
            {
              <p>@Model.Overview</p>
            }
            else
            {
              <p>@shortendText</p>
              
              <details class="govuk-details govuk-!-margin-top-2" data-module="govuk-details">
                <summary class="govuk-details__summary">
                  <span class="govuk-details__summary-text">Read more of the course overview</span>
                </summary>
                <div class="govuk-details__text">@tailEndText</div>
              </details>
            }
          }
        </dd>
      </div>
    </dl>
  </div>
</div>
<!-- End Course Card-->
  